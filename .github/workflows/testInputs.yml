name: Deploy Release Container

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      AppId:
        description: 'PlanIT application ID number (ex. "4853")'
        required: true
        type: string
      VpcId:
        description: 'VPC to provision the pipeline'
        required: true
        type: string
      RepositoryName:
        description: 'GitHub Enterprise repository name (ex. "HIG/ds_mlops_core_dags")'
        required: true
        type: string
      BranchName:
        description: 'GitHub Enterprise branch name'
        required: true
        type: string
      ReleaseName:
        description: 'Release Name Of Astro Deployment'
        required: true
        type: string
      AirflowVersion:
        description: 'Version tag of Airflow (ex. 2.4.3-2)'
        required: true
        type: string
      TimeoutAndRegion:
        description: 'JSON for TimeoutInMinutes and AWSRegion'
        required: true
        default: '{"AWSRegion":"us-west1","TimeoutInMinutes":10}'
        type: string

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        var: [AppId, VpcId, RepositoryName, BranchName, ReleaseName, AirflowVersion, TimeoutAndRegion]
    steps:
      - name: Validate Inputs
        run: |
          VALUE="${{ github.event.inputs[matrix.var] }}"
          if [[ -z "$VALUE" ]]; then
            echo "Error: ${{ matrix.var }} is required"
            exit 1
          fi
          
  validate-account:
    runs-on: ubuntu-latest
    steps:
      - name: Validate AWS Account and Release Name
        run: |
          AWS_ACCOUNT_ID="${{ github.event.inputs.AWS_ACCOUNT_ID }}"
          RELEASE_NAME="${{ github.event.inputs.RELEASE_NAME }}"

          echo "AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID"
          echo "RELEASE_NAME: $RELEASE_NAME"

          # Define allowed accounts and release names
          declare -A ACCOUNT_RELEASE_MAP
          ACCOUNT_RELEASE_MAP["252898585127"]="claims-dsc claims-preprod claims-prod"
          ACCOUNT_RELEASE_MAP["805528740914"]="pl-dsc pl-preprod pl-prod"
          ACCOUNT_RELEASE_MAP["063345380468"]="mlc-discovery mlc-preprod mlc-prod"
          ACCOUNT_RELEASE_MAP["844127575310"]="sc-discovery sc-preprod sc-prod"
          ACCOUNT_RELEASE_MAP["902854700762"]="ilab-discovery cmra-discovery cmra-prod ulm-discovery ulm-prod"
          ACCOUNT_RELEASE_MAP["923397148186"]="gb-discovery gb-preprod gb-prod"
          ACCOUNT_RELEASE_MAP["102443476650"]="gs-discovery gs-preprod gs-prod"

          # Check if AWS_ACCOUNT_ID is authorized
          if [[ ! -v ACCOUNT_RELEASE_MAP[$AWS_ACCOUNT_ID] ]]; then
            echo "ERROR: Account ID $AWS_ACCOUNT_ID is not authorized!"
            exit 1
          fi

          # Check if RELEASE_NAME is allowed for the given AWS_ACCOUNT_ID
          ALLOWED_RELEASES=${ACCOUNT_RELEASE_MAP[$AWS_ACCOUNT_ID]}
          if [[ ! " $ALLOWED_RELEASES " =~ " $RELEASE_NAME " ]]; then
            echo "ERROR: Release Name $RELEASE_NAME is not authorized for Account $AWS_ACCOUNT_ID!"
            exit 1
          fi

          echo "Validation successful!"

  setup:
    runs-on: ubuntu-latest
    needs: validate-inputs
    steps:
      - name: Parse Inputs
        id: parse_inputs
        run: |
          echo "APP_ID=${{ github.event.inputs.AppId }}" >> $GITHUB_ENV
          echo "VPC_ID=${{ github.event.inputs.VpcId }}" >> $GITHUB_ENV
          echo "REPOSITORY_NAME=${{ github.event.inputs.RepositoryName }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.event.inputs.BranchName }}" >> $GITHUB_ENV
          echo "RELEASE_NAME=${{ github.event.inputs.ReleaseName }}" >> $GITHUB_ENV
          echo "AIRFLOW_VERSION=${{ github.event.inputs.AirflowVersion }}" >> $GITHUB_ENV
          
          echo '${{ github.event.inputs.TimeoutAndRegion }}' > timeout_region.json
          cat timeout_region.json | jq .

          echo "AWS_REGION=$(jq -r '.AWSRegion' timeout_region.json)" >> $GITHUB_ENV
          echo "TIMEOUT_IN_MINUTES=$(jq -r '.TimeoutInMinutes' timeout_region.json)" >> $GITHUB_ENV

      - name: Print Parsed Inputs
        run: |
          echo "AppId: $APP_ID"
          echo "VpcId: $VPC_ID"
          echo "RepositoryName: $REPOSITORY_NAME"
          echo "BranchName: $BRANCH_NAME"
          echo "ReleaseName: $RELEASE_NAME"
          echo "AirflowVersion: $AIRFLOW_VERSION"
          echo "AWSRegion: $AWS_REGION"
          echo "TimeoutInMinutes: $TIMEOUT_IN_MINUTES"
